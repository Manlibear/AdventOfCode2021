@page "/Day5"
@inject AdventOfCodeBlazor.Services.IDayApi DayApi

<PageTitle>@MainLayout.SiteTitle("Day 5")</PageTitle>

<div class="day" data-simplebar>
    <div class="row">
        <div class="col-md-6">
            <h2>Part 1: @answer1</h2>
        </div>
        <div class="col-md-6">
            <h2>Part 2: @answer2</h2>
        </div>
    </div>
    <DayCode />
</div>

@code
{
    string answer1 = "";
    string answer2 = "";

    protected override async Task OnInitializedAsync()
    {
        await DayApi.GetDayInput(5).ContinueWith((str) =>
        {
            List<Line> lines = str.Result.Split("\n").Select(x => new Line(x)).ToList();
            List<Line> straightLines = lines.Where(x => x.IsStraight).ToList();
            List<Line> diagonalLines = lines.Where(x => !x.IsStraight).ToList();

            // we need to know the max values to create the grid
            var gridMaxX = lines.Max(x => Math.Max(x.Start.X, x.End.X));
            var gridMaxY = lines.Max(x => Math.Max(x.Start.Y, x.End.Y));

            // make the grid using the above sizes
            int[][] grid = new int[gridMaxY + 1][];
            for (int i = 0; i <= gridMaxY; i++)
                grid[i] = new int[gridMaxX + 1];

            // paint the straight lines onto the grid
            foreach (var l in straightLines)
            {
                var minX = Math.Min(l.Start.X, l.End.X);
                var maxX = Math.Max(l.Start.X, l.End.X);

                var minY = Math.Min(l.Start.Y, l.End.Y);
                var maxY = Math.Max(l.Start.Y, l.End.Y);

                for (int x = minX; x <= maxX; x++)
                {
                    for (int y = minY; y <= maxY; y++)
                    {
                        grid[y][x]++;
                    }
                }
            }

            // total up the straight line overlaps now before we draw the diagonals
            var straightOverlaps = grid.SelectMany(r => r.Where(c => c > 1)).Count();
            answer1 = straightOverlaps.ToString();

            // draw the diagonals
            foreach (var l in diagonalLines)
            {
                Vector dir = Vector.FromLine(l.Start, l.End);
                Vector readPoint = l.Start.ToVector();
                Vector end = l.End.ToVector();

                grid[readPoint.Y][readPoint.X]++;
                while (readPoint != end)
                {
                    readPoint += dir;
                    grid[readPoint.Y][readPoint.X]++;
                }
            }

            var allOverlaps = grid.SelectMany(r => r.Where(c => c > 1)).Count();
            answer2 = allOverlaps.ToString();
        });
    }

    public class Vector
    {
        public int X { get; set; }
        public int Y { get; set; }

        public static Vector FromLine(Coordinate start, Coordinate end)
        {
            var difX = end.X - start.X;
            var difY = end.Y - start.Y;
            Vector vect = new Vector(0, 0);

            if (difX != 0)
                vect.X = difX > 0 ? 1 : -1;

            if (difY != 0)
                vect.Y = difY > 0 ? 1 : -1;

            return vect;
        }

        public Vector(int x, int y)
        {
            X = x;
            Y = y;
        }

        public static Vector operator +(Vector a, Vector b) => new Vector(a.X + b.X, a.Y + b.Y);
        public static bool operator ==(Vector a, Vector b) => a.X == b.X && a.Y == b.Y;
        public static bool operator !=(Vector a, Vector b) => a.X != b.X || a.Y != b.Y;
    }

    public class Coordinate
    {
        public int X { get; set; }
        public int Y { get; set; }
        public Coordinate(string info)
        {
            var point = info.Split(",");
            X = int.Parse(point[0]);
            Y = int.Parse(point[1]);
        }

        public Vector ToVector()
        {
            return new Vector(X, Y);
        }
    }

    public class Line
    {
        public Coordinate Start { get; set; }
        public Coordinate End { get; set; }
        public bool IsStraight => (Start.X == End.X || Start.Y == End.Y);

        public Line(string info)
        {
            var coords = info.Split(" -> ");
            Start = new Coordinate(coords[0]);
            End = new Coordinate(coords[1]);
        }
    }
}